<html>

  <head>
    <title>OHMS Admin Panel</title>
    <link href="{{options.base_url}}/{{options.static}}/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{options.base_url}}/{{options.static}}/css/style.css" rel="stylesheet">
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  </head>

  <body>

    <div class="span12">

    <h2>OHMS Admin Panel</h2>

    <hr/>

    <h3>Enter User View</h3>

    <p>This feature allows you to see the system from the perspective of any user. This is useful in case a student claims 
there is a problem with the system, and you would like to see what they're seeing.</p>

    <p><b><font color="red">Warning!</font></b> Once you enter the user's view, the link to this Admin Panel will no longer be visible 
from the main page. When you  are ready to switch back to your own view, you must type in the URL (<tt>/cgi-bin/index.cgi/admin</tt>) 
to return to this page. Once you are here, you can simply enter your User ID in the box below to return to your own view.</p>

    <form action="change_user" method="POST">
    User ID: <input type="text" name="user"/> <input type="submit" value="Enter View!"/>
    </form>

    <hr/>

    <h3>Gradebook</h3>

    <p class="lead">Click <a href="download_grades">here</a> to download the grades as a CSV file.</p>

    <p>Grades are only shown for students in the class. To remove a student from the list, change his or her status to "Guest". To hide all columns except for one (useful if you are entering grades), click the header of the column you want to keep.</p>

    <script type="text/javascript">
    var scores = [["Student", "Score"]];
    var assignment = "";

    google.load("visualization", "1", {packages:["corechart"]});

    function drawChart() {
      var data = google.visualization.arrayToDataTable(scores);

      var options = {
          title: 'Scores on ' + assignment,
          legend: { position: 'none' },
          titleTextStyle: { fontSize: 24 },
          chartArea: {
            left: '10%',
            top: '10%',
            width: '80%',
            height: '80%'
          },
      };

      var chart = new google.visualization.Histogram(document.getElementById('histogram'));
      chart.draw(data, options);
    }

    function hide_all_other_columns(i) {
      var sum = 0;
      var sum_sq = 0;
      var n = 0;
      var missing = [];
      var table = $("table#gradebook");
      var students = table.find('td:nth-child(1)').contents(); 
      for(var j=0; j<1+{{categories|length}}+{{homeworks|length}}; j++) {
        if(j !== i) {
          table.find('td:nth-child(' + (j+4) + '),th:nth-child(' + (j+4) + ')').hide();
        } else {
          assignment = table.find('th:nth-child(' + (j+4) + ')').text();
          var elts = table.find('td:nth-child(' + (j+4) + ')').map(function() {
                                     return $(this).attr("value");
                                 });
	  for(var k=0; k < elts.size(); k++) {
             var score = parseFloat(elts.get(k));
	     if(isNaN(score)) missing.push(students.get(k).data)
             else {
		scores.push([students.get(k).data, score]);
                n += 1;
                sum += score;
                sum_sq += Math.pow(score, 2);			   
	     }
          }
        }
      }
      $("div#histogram").css("height", "500px");
      drawChart();
      $("div#missing").text("These students' scores are missing: " + missing.join(", "));
      $("div#stats").text("Mean: " + (sum / n).toFixed(2) + ", SD: " + 
                          (Math.sqrt(sum_sq / n - Math.pow(sum / n, 2))).toFixed(2));
    }
    </script>

    <div align="center">
      <div id="histogram" class="span12"></div>
      <div id="missing" class="span12"></div>
      <div id="stats" class="lead"></div>
    </div>

    <table id="gradebook" class="table table-striped">
      <thead>
	<th>Student Name</th>
	<th>User ID</th>
	<th>Type</th>

	<th><a href="#" onclick="hide_all_other_columns(0)">Overall</a></th>

	{% for category in categories %}
	<th><a href="#" onclick="hide_all_other_columns({{ 1 + loop.index0 }})">{{ category.name }} Total</a></th>
	{% endfor %}

	{% for homework in homeworks %}
	<th><a href="#" onclick="hide_all_other_columns({{ 1 + loop.index0 + categories|length }})">{{ homework.name }}</a></th>
	{% endfor %}
      </thead>
      <tbody>
	{% for student, grades in gradebook %}
        <tr stuid="{{ student.stuid }}">
	  <td>{{ student.name }}</td>
	  <td>{{ student.stuid }}</td>
	  <td>
	    <form target="_blank" action="change_user_type" method="POST">
	      <input type="hidden" name="user" value="{{ student.stuid }}" />
	      <select name="type" class="input-small">
		<option value="student" selected>Student</option>
		<option value="guest">Guest</option>
		<option value="admin">Admin</option>
	      </select>
	      <input type="submit" value="Update!" />
	    </form>
	  </td>

	  <td value={{ grades["overall"]|round(3) }}>{{ grades["overall"]|round(1) }}%</td>

	  {% for category in categories %}
	  <td value={{ grades[category.name] }}>{{ grades[category.name] }}</td>
	  {% endfor %}
	  {% for hw in homeworks %}
	  <td hw_id="{{ hw.id }}" value="{% if hw.id in grades %}{{
					 grades[hw.id].score }}{% endif
					 %}">
	    {% if hw.questions|length %}
	      {% if hw.id in grades %}{{ grades[hw.id].score }}{% endif %}
	    {% else %}
	    <input type="text" class="input-mini grade" 
		   value="{% if hw.id in grades %}{{ grades[hw.id].score }}{% endif %}"/></td>
	    {% endif %}
	  {% endfor %}
	</tr>
	{% endfor %}
      </tbody>
    </table>

    <hr/>

    <h3>Other Users</h3>

    <table class="table">
      <thead>
	<th>Guests</th>
	<th>Actions</th>
      </thead>
      {% for guest in guests %}
        <tr>
	  <td>{{ guest.name }}</td>
	  <form target="_blank" action="change_user_type" method="POST">
	  <td>
	    <input type="hidden" name="user" value="{{ guest.stuid }}" />
	    <select name="type" class="input-small">
	      <option value="student">Student</option>
	      <option value="guest" selected>Guest</option>
	      <option value="admin">Admin</option>
	    </select>
	    <input type="submit" value="Update!" />
	  </td>
	  </form>
	</tr>
      {% endfor %}
    </table>

    <table class="table">
      <thead>
	<th>Admins</th>
	<th>Actions</th>
      </thead>
      {% for admin in admins %}
        <tr>
	  <td>{{ admin.name }}</td>
	  <form target="_blank" action="change_user_type" method="POST">
	  <td>
	    <input type="hidden" name="user" value="{{ admin.stuid }}" />
	    <select name="type" class="input-small">
	      <option value="student">Student</option>
	      <option value="guest">Guest</option>
	      <option value="admin" selected>Admin</option>
	    </select>
	    <input type="submit" value="Update!" />
	  </td>
	  </form>
	</tr>
      {% endfor %}
    </table>


    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="{{options.base_url}}/{{options.static}}/js/admin/index.js"></script>

  </body>

</html>
